<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microsoft Clarity 验证页面</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    pre {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Microsoft Clarity 集成验证</h1>
    
    <div id="status-container">
      <div class="status info">正在检查 Microsoft Clarity 状态...</div>
    </div>

    <h2>检查结果</h2>
    <div id="results"></div>

    <h2>测试功能</h2>
    <button onclick="testClarityEvent()">测试自定义事件</button>
    <button onclick="testClarityTag()">测试标签设置</button>
    <button onclick="checkClarityStatus()">重新检查状态</button>

    <h2>调试信息</h2>
    <pre id="debug-info"></pre>
  </div>

  <!-- Microsoft Clarity -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "swn8w0ju3d");
  </script>

  <script>
    let clarityCheckInterval;
    
    function updateStatus(message, type = 'info') {
      const container = document.getElementById('status-container');
      container.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      results.innerHTML += `<div class="status ${type}">${message}</div>`;
    }

    function updateDebugInfo() {
      const debugInfo = document.getElementById('debug-info');
      const info = {
        'window.clarity 存在': !!window.clarity,
        'clarity 函数类型': typeof window.clarity,
        'clarity 队列': window.clarity && window.clarity.q ? window.clarity.q.length : 'N/A',
        'Clarity 脚本加载': !!document.querySelector('script[src*="clarity.ms"]'),
        'User Agent': navigator.userAgent,
        '当前时间': new Date().toISOString()
      };
      
      debugInfo.textContent = JSON.stringify(info, null, 2);
    }

    function checkClarityStatus() {
      updateStatus('正在检查 Microsoft Clarity 状态...', 'info');
      
      // 清空之前的结果
      document.getElementById('results').innerHTML = '';
      
      // 检查 Clarity 脚本是否加载
      const clarityScript = document.querySelector('script[src*="clarity.ms"]');
      if (clarityScript) {
        addResult('✓ Clarity 脚本标签已创建', 'success');
        
        // 检查脚本加载状态
        if (clarityScript.readyState === 'complete' || clarityScript.readyState === 'loaded') {
          addResult('✓ Clarity 脚本加载完成', 'success');
        } else {
          addResult('⚠ Clarity 脚本正在加载中...', 'info');
        }
      } else {
        addResult('✗ Clarity 脚本标签未找到', 'error');
      }

      // 测试网络连接
      testClarityNetworkConnection();

      // 检查 window.clarity 是否存在
      if (window.clarity) {
        addResult('✓ window.clarity 对象存在', 'success');
        
        // 检查 clarity 函数是否可调用
        if (typeof window.clarity === 'function') {
          addResult('✓ clarity 函数可调用', 'success');
          updateStatus('Microsoft Clarity 已成功加载并可用', 'success');
        } else {
          addResult('✗ clarity 不是函数类型', 'error');
          updateStatus('Microsoft Clarity 加载异常', 'error');
        }
      } else {
        addResult('✗ window.clarity 对象不存在', 'error');
        updateStatus('Microsoft Clarity 未正确加载', 'error');
      }

      updateDebugInfo();
    }

    function testClarityNetworkConnection() {
      // 测试 clarity.ms 的网络连接
      const testUrl = 'https://www.clarity.ms/tag/swn8w0ju3d';
      
      fetch(testUrl, { 
        method: 'HEAD', 
        mode: 'no-cors',
        cache: 'no-cache'
      })
      .then(() => {
        addResult('✓ clarity.ms 网络连接正常', 'success');
      })
      .catch((error) => {
        addResult('✗ clarity.ms 网络连接失败: ' + error.message, 'error');
        addResult('可能的原因: 网络防火墙、DNS问题或地区限制', 'info');
      });
    }

    function testClarityEvent() {
      if (!window.clarity) {
        alert('Clarity 未加载，无法测试事件');
        return;
      }

      try {
        // 使用 clarity 记录自定义事件
        window.clarity('event', 'test_button_click');
        addResult('✓ 自定义事件已发送: test_button_click', 'success');
      } catch (error) {
        addResult('✗ 发送自定义事件失败: ' + error.message, 'error');
      }
    }

    function testClarityTag() {
      if (!window.clarity) {
        alert('Clarity 未加载，无法测试标签');
        return;
      }

      try {
        // 使用 clarity 设置标签
        window.clarity('set', 'test_tag', 'test_value_' + Date.now());
        addResult('✓ 标签已设置: test_tag', 'success');
      } catch (error) {
        addResult('✗ 设置标签失败: ' + error.message, 'error');
      }
    }

    // 页面加载完成后开始检查
    window.addEventListener('load', function() {
      // 等待一段时间让 Clarity 脚本加载
      setTimeout(() => {
        checkClarityStatus();
      }, 2000);

      // 定期检查 Clarity 状态
      clarityCheckInterval = setInterval(() => {
        if (window.clarity && typeof window.clarity === 'function') {
          clearInterval(clarityCheckInterval);
          updateStatus('Microsoft Clarity 已成功加载并可用', 'success');
        }
      }, 1000);

      // 10秒后停止检查
      setTimeout(() => {
        if (clarityCheckInterval) {
          clearInterval(clarityCheckInterval);
        }
      }, 10000);
    });

    // 记录页面访问
    window.addEventListener('load', function() {
      if (window.clarity) {
        window.clarity('event', 'clarity_verification_page_loaded');
      }
    });
  </script>
</body>
</html>
