.PHONY: all clean local

# 定义目录
PROTO_DIR = .\definitions
GEN_DIR = .\gen\go
TS_GEN_DIR = .\gen\ts
LOCAL_GEN_DIR = .\local-gen\go
LOCAL_TS_GEN_DIR = .\local-gen\ts
PROTO_OUT = .
MODULE_PREFIX = github.com/yb2020/go-sea/proto

# 设置 Windows 命令
SHELL = cmd.exe

# 获取 protoc include 路径
PROTOC_INCLUDE = C:\protoc\include

# 自动发现所有模块目录（Windows 方式）
MODULES = $(shell powershell -Command "Get-ChildItem -Path $(PROTO_DIR) -Directory | Select-Object -ExpandProperty Name")

# 检查 TypeScript 插件是否存在
check-ts-plugin:
	@powershell -Command "$$tsPlugin = 'D:\nodejs\protoc-gen-ts.cmd'; if (Test-Path $$tsPlugin) { Write-Host '[Success] TypeScript plugin found at ' $$tsPlugin } else { Write-Host '[Warning] TypeScript plugin not found at ' $$tsPlugin; Write-Host 'To install: npm install --global @protobuf-ts/plugin'; exit 1 }"

# 默认目标：编译所有 proto 文件
all: check-ts-plugin prepare compile-all move-ts-files

# 本地开发目标：编译所有 proto 文件但不提交
local: check-ts-plugin local-prepare compile-local-all move-local-ts-files

# 清理生成的代码
clean:
	@if exist "$(GEN_DIR)" rd /s /q "$(GEN_DIR)"
	@if exist "$(TS_GEN_DIR)" rd /s /q "$(TS_GEN_DIR)"
	@if exist "$(LOCAL_GEN_DIR)" rd /s /q "$(LOCAL_GEN_DIR)"
	@if exist "$(LOCAL_TS_GEN_DIR)" rd /s /q "$(LOCAL_TS_GEN_DIR)"
	@if exist "github.com" rd /s /q "github.com"

# 准备输出目录
prepare:
	@echo [Info] Found modules: $(MODULES)
	@if not exist "$(GEN_DIR)" mkdir "$(GEN_DIR)"
	@if not exist "$(TS_GEN_DIR)" mkdir "$(TS_GEN_DIR)"
	@for %%i in ($(MODULES)) do @if not exist "$(GEN_DIR)\%%i" mkdir "$(GEN_DIR)\%%i"
	@for %%i in ($(MODULES)) do @if not exist "$(TS_GEN_DIR)\%%i" mkdir "$(TS_GEN_DIR)\%%i"
	@powershell -Command "$$dirs = Get-ChildItem -Path '$(PROTO_DIR)' -Recurse -Directory | Where-Object { $$_.FullName -ne '$(PROTO_DIR)' }; foreach ($$dir in $$dirs) { $$relPath = $$dir.FullName.Substring('$(PROTO_DIR)'.Length + 1); $$goDir = '$(GEN_DIR)' + '\' + $$relPath; $$tsDir = '$(TS_GEN_DIR)' + '\' + $$relPath; if (-not (Test-Path $$goDir)) { mkdir $$goDir -Force | Out-Null }; if (-not (Test-Path $$tsDir)) { mkdir $$tsDir -Force | Out-Null } }"

# 准备本地输出目录
local-prepare:
	@echo [Info] Found modules: $(MODULES)
	@if not exist "$(LOCAL_GEN_DIR)" mkdir "$(LOCAL_GEN_DIR)"
	@if not exist "$(LOCAL_TS_GEN_DIR)" mkdir "$(LOCAL_TS_GEN_DIR)"
	@for %%i in ($(MODULES)) do @if not exist "$(LOCAL_GEN_DIR)\%%i" mkdir "$(LOCAL_GEN_DIR)\%%i"
	@for %%i in ($(MODULES)) do @if not exist "$(LOCAL_TS_GEN_DIR)\%%i" mkdir "$(LOCAL_TS_GEN_DIR)\%%i"
	@powershell -Command "$$dirs = Get-ChildItem -Path '$(PROTO_DIR)' -Recurse -Directory | Where-Object { $$_.FullName -ne '$(PROTO_DIR)' }; foreach ($$dir in $$dirs) { $$relPath = $$dir.FullName.Substring('$(PROTO_DIR)'.Length + 1); $$goDir = '$(LOCAL_GEN_DIR)' + '\' + $$relPath; $$tsDir = '$(LOCAL_TS_GEN_DIR)' + '\' + $$relPath; if (-not (Test-Path $$goDir)) { mkdir $$goDir -Force | Out-Null }; if (-not (Test-Path $$tsDir)) { mkdir $$tsDir -Force | Out-Null } }"
	@powershell -Command "if (-not (Select-String -Path '.gitignore' -Pattern '^/local-gen/' -Quiet)) { Add-Content -Path '.gitignore' -Value '/local-gen/' }"

# 编译所有模块
compile-all:
	@powershell -Command "foreach ($$module in '$(MODULES)'.Split()) { if ($$module) { Write-Host '[Compiling] ' $$module; $$protoFiles = Get-ChildItem -Path \"$(PROTO_DIR)\$$module\" -Filter '*.proto' -Recurse; if ($$protoFiles) { if ($$module -eq 'validate') { Write-Host '[Generating] Go code for ' $$module; foreach ($$protoFile in $$protoFiles) { $$relPath = $$protoFile.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/'); $$cmd = \"protoc -I. --go_out=./gen/go --go_opt=paths=source_relative `\"$$relPath`\"\"; Invoke-Expression $$cmd; if ($$LASTEXITCODE -ne 0) { Write-Host '[Error] Failed to generate Go code for ' $$protoFile.Name; exit 1 } } Write-Host '[Success] Go code for ' $$module } else { Write-Host '[Generating] Go code for ' $$module; foreach ($$protoFile in $$protoFiles) { $$relPath = $$protoFile.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/'); $$cmd = \"protoc -I. --go_out=./gen/go --go_opt=paths=source_relative --go-grpc_out=./gen/go --go-grpc_opt=paths=source_relative --validate_out=`\"lang=go,paths=source_relative:./gen/go`\" `\"$$relPath`\"\"; Invoke-Expression $$cmd; if ($$LASTEXITCODE -ne 0) { Write-Host '[Error] Failed to generate Go code for ' $$protoFile.Name; exit 1 } } Write-Host '[Success] Go code for ' $$module; Write-Host '[Generating] TypeScript code for ' $$module; foreach ($$protoFile in $$protoFiles) { $$relPath = $$protoFile.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/'); $$cmd = \"protoc -I. --plugin=protoc-gen-ts=`\"D:\nodejs\protoc-gen-ts.cmd`\" --ts_out=`\"use_proto_field_name:$(TS_GEN_DIR)`\" `\"$$relPath`\"\"; Invoke-Expression $$cmd; if ($$LASTEXITCODE -ne 0) { Write-Host '[Error] Failed to generate TypeScript code for ' $$protoFile.Name; exit 1 } } Write-Host '[Success] TypeScript code for ' $$module } } else { Write-Host '[Skip] No proto files found for ' $$module } } }"
	@call move_ts_files.bat
	@call move_go_files.bat

# 编译所有本地模块
compile-local-all:
	@powershell -Command "foreach ($$module in '$(MODULES)'.Split()) { if ($$module) { Write-Host '[Compiling] ' $$module; $$protoFiles = Get-ChildItem -Path \"$(PROTO_DIR)\$$module\" -Filter '*.proto' -Recurse; if ($$protoFiles) { if ($$module -eq 'validate') { Write-Host '[Generating] Go code for ' $$module; foreach ($$protoFile in $$protoFiles) { $$relPath = $$protoFile.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/'); $$cmd = \"protoc -I. --go_out=./local-gen/go --go_opt=paths=source_relative `\"$$relPath`\"\"; Invoke-Expression $$cmd; if ($$LASTEXITCODE -ne 0) { Write-Host '[Error] Failed to generate Go code for ' $$protoFile.Name; exit 1 } } Write-Host '[Success] Go code for ' $$module } else { Write-Host '[Generating] Go code for ' $$module; foreach ($$protoFile in $$protoFiles) { $$relPath = $$protoFile.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/'); $$cmd = \"protoc -I. --go_out=./local-gen/go --go_opt=paths=source_relative --go-grpc_out=./local-gen/go --go-grpc_opt=paths=source_relative --validate_out=`\"lang=go,paths=source_relative:./local-gen/go`\" `\"$$relPath`\"\"; Invoke-Expression $$cmd; if ($$LASTEXITCODE -ne 0) { Write-Host '[Error] Failed to generate Go code for ' $$protoFile.Name; exit 1 } } Write-Host '[Success] Go code for ' $$module; Write-Host '[Generating] TypeScript code for ' $$module; foreach ($$protoFile in $$protoFiles) { $$relPath = $$protoFile.FullName.Substring((Get-Location).Path.Length + 1).Replace('\', '/'); $$cmd = \"protoc -I. --plugin=protoc-gen-ts=`\"D:\nodejs\protoc-gen-ts.cmd`\" --ts_out=`\"use_proto_field_name,generate_dependencies:./local-gen/ts`\" `\"$$relPath`\"\"; Invoke-Expression $$cmd; if ($$LASTEXITCODE -ne 0) { Write-Host '[Error] Failed to generate TypeScript code for ' $$protoFile.Name; exit 1 } } Write-Host '[Success] TypeScript code for ' $$module } } else { Write-Host '[Skip] No proto files found for ' $$module } } }"
	@call move_local_ts_files.bat
	@call move_local_go_files.bat

# 移动TypeScript文件
move-ts-files:
	@powershell -Command "if (Test-Path '$(TS_GEN_DIR)\definitions') { $$files = Get-ChildItem -Path '$(TS_GEN_DIR)\definitions' -Recurse -Filter '*.ts'; foreach ($$file in $$files) { $$relPath = $$file.DirectoryName.Substring('$(TS_GEN_DIR)\definitions'.Length); $$destDir = '$(TS_GEN_DIR)' + $$relPath; if (-not (Test-Path $$destDir)) { mkdir $$destDir -Force | Out-Null }; Copy-Item -Path $$file.FullName -Destination $$destDir -Force }; Remove-Item -Path '$(TS_GEN_DIR)\definitions' -Recurse -Force }"
	@powershell -Command "if (Test-Path '$(TS_GEN_DIR)\local-gen') { Remove-Item -Path '$(TS_GEN_DIR)\local-gen' -Recurse -Force }"
	@powershell -Command "if (Test-Path 'local-gen\ts-sea-proto') { Remove-Item -Path 'local-gen\ts-sea-proto' -Recurse -Force }"

# 移动本地TypeScript文件
move-local-ts-files:
	@powershell -Command "if (Test-Path '$(LOCAL_TS_GEN_DIR)\definitions') { $$files = Get-ChildItem -Path '$(LOCAL_TS_GEN_DIR)\definitions' -Recurse -Filter '*.ts'; foreach ($$file in $$files) { $$relPath = $$file.DirectoryName.Substring('$(LOCAL_TS_GEN_DIR)\definitions'.Length); $$destDir = '$(LOCAL_TS_GEN_DIR)' + $$relPath; if (-not (Test-Path $$destDir)) { mkdir $$destDir -Force | Out-Null }; Copy-Item -Path $$file.FullName -Destination $$destDir -Force }; Remove-Item -Path '$(LOCAL_TS_GEN_DIR)\definitions' -Recurse -Force }"
	@powershell -Command "if (Test-Path '$(LOCAL_TS_GEN_DIR)\local-gen') { Remove-Item -Path '$(LOCAL_TS_GEN_DIR)\local-gen' -Recurse -Force }"
	@powershell -Command "if (Test-Path 'local-gen\ts-sea-proto') { Remove-Item -Path 'local-gen\ts-sea-proto' -Recurse -Force }"

# 显示所有可用的模块
list-modules:
	@echo Available modules: $(MODULES)

# 显示帮助信息
help:
	@echo Available targets:
	@echo   all          - Compile all proto files
	@echo   local        - Compile all proto files for local development (output to local-gen/)
	@echo   clean        - Remove generated code
	@echo   list-modules - List all available modules
	@echo   check-ts-plugin - Check if TypeScript plugin is installed
	@echo                  Available modules: $(MODULES)
